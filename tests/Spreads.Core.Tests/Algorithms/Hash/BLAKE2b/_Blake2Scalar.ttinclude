<#@ assembly name="System.Core" #>
//------------------------------------------------------------------------------
//	<auto-generated>
//		This code was generated from a template.
//		Manual changes will be overwritten if the code is regenerated.
//	</auto-generated>
//------------------------------------------------------------------------------

#if HAS_AGGR_OPT
using System.Runtime.CompilerServices;
#endif

namespace Spreads.Core.Tests.Algorithms.Hash.BLAKE2b
{
	unsafe public partial struct Blake2<#= alg.suffix #>Context
	{
#if HAS_AGGR_OPT
		[MethodImpl(MethodImplOptions.AggressiveOptimization)]
#endif
		private static void mixScalar(<#= alg.wtype #>* sh, <#= alg.wtype #>* m)
		{
<#
for (int i = 0; i < 16; i++) {
#>
			<#= alg.wtype #> m<#=i.ToString("d2")#> = m[<#=i.ToString("d2")#>];
<#
}

WriteLine(null);
mixvars (alg, new[] { 0, 1, 2, 3, 4, 5, 6, 7 });
mixvars (alg, new[] { 8, 9, 10, 11, 12, 13, 14, 15 });
#>
			v12 ^= sh[8];  // t[0]
			v13 ^= sh[9];  // t[1]
			v14 ^= sh[10]; // f[0]

<#
for (int i = 0; i < alg.rounds; i++) {
	int s = i % 10;
	WriteLine($"\t\t\t//ROUND {i+1}");
	mix(alg, 0, 4,  8, 12, sigma[s][ 0], 1);
	mix(alg, 1, 5,  9, 13, sigma[s][ 2], 1);
	mix(alg, 2, 6, 10, 14, sigma[s][ 4], 1);
	mix(alg, 3, 7, 11, 15, sigma[s][ 6], 1);

	mix(alg, 2, 6, 10, 14, sigma[s][ 5], 2);
	mix(alg, 3, 7, 11, 15, sigma[s][ 7], 2);
	mix(alg, 0, 4,  8, 12, sigma[s][ 1], 2);
	mix(alg, 1, 5,  9, 13, sigma[s][ 3], 2);

	mix(alg, 0, 5, 10, 15, sigma[s][ 8], 1);
	mix(alg, 1, 6, 11, 12, sigma[s][10], 1);
	mix(alg, 2, 7,  8, 13, sigma[s][12], 1);
	mix(alg, 3, 4,  9, 14, sigma[s][14], 1);

	mix(alg, 2, 7,  8, 13, sigma[s][13], 2);
	mix(alg, 3, 4,  9, 14, sigma[s][15], 2);
	mix(alg, 0, 5, 10, 15, sigma[s][ 9], 2);
	mix(alg, 1, 6, 11, 12, sigma[s][11], 2);
}

for (int i = 0; i < 8; i++) {
#>
			sh[<#=i#>] ^= v<#=i.ToString("d2")#> ^ v<#=(i+8).ToString("d2")#>;
<#
}
#>
		}
	}
}
<#+

string ror(b2alg alg, string x, int y) => $"({x} >> {y,2}) ^ ({x} << {(alg.bits - y),2})";

void mixvars(b2alg alg, int[] pos)
{
	foreach (int j in pos) {
#>
			<#= alg.wtype #> v<#=j.ToString("d2")#> = <#= j < 8 ? $"sh[{j}]" : string.Format(alg.ivfmt, alg.iv[j-8]) #>;
<#+
	}
	WriteLine(null);
}

void mix(b2alg alg, int a, int b, int c, int d, int s, int p)
{
	string sa = a.ToString("d2");
	string sb = b.ToString("d2");
	string sc = c.ToString("d2");
	string sd = d.ToString("d2");
	string ss = s.ToString("d2");
#>
			v<#=sa#> += m<#=ss#>;
			v<#=sa#> += v<#=sb#>;
			v<#=sd#> ^= v<#=sa#>;
			v<#=sd#> = <#=ror(alg, string.Concat("v", sd), p == 1 ? (alg.bits / 2) : (alg.bits / 4))#>;
			v<#=sc#> += v<#=sd#>;
			v<#=sb#> ^= v<#=sc#>;
			v<#=sb#> = <#=ror(alg, string.Concat("v", sb), p == 1 ? (alg.bits / 8 * 3) : (alg.bits == 64 ? 63 : 7))#>;

<#+
}
#>
